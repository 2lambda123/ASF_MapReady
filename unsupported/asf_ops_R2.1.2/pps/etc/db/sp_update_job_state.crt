/*************************************************************************
 * Copyright(c) 1996, California Institute of Technology.                *
 *             ALL RIGHTS RESERVED.                                      *
 * U.S. Government Sponsorship acknowledged.                             *
 *************************************************************************/
/*=======================
        @(#)sp_update_job_state.crt	1.2  11/27/96
=========================*/

if exists (select * from sysobjects where name = "sp_update_job_state")
	drop proc sp_update_job_state
go

create proc sp_update_job_state (@job_id int, 
		@job_state JobStateType)
as
	declare @current_job_state JobStateType

	select @current_job_state = job_state
		from jobs 
		where job_id = @job_id

	if (@current_job_state = "COMPLETED" or
	    @current_job_state = "CANCEL/FAIL") 
		return 0

	begin transaction

	
	update jobs
		set job_state = @job_state,
		    state_date = getdate()
		where job_id = @job_id

	/* update trigger will update job_state in ppsgui_orders table */

        if (@@transtate > 0)
        begin
                rollback transaction
                return -100 
        end

	commit transaction

	return 1 
go
