/*************************************************************************
 * Copyright(c) 1996, California Institute of Technology.                *
 *             ALL RIGHTS RESERVED.                                      *
 * U.S. Government Sponsorship acknowledged.                             *
 *************************************************************************/
/*=======================
	@(#)tr_jobs_update.crt	1.4  12/17/96
=========================*/

if exists (select * from sysobjects where name = "tr_jobs_update")
        drop trigger tr_jobs_update
go

create trigger tr_jobs_update
     on jobs
     for update
as
begin
     declare @num_rows int
     select @num_rows = @@rowcount
     if @num_rows = 0
             return
 
         if update (job_state)
	 begin
	     delete schedule
		        from schedule , inserted
			where schedule.job_id = inserted.job_id
			and   inserted.job_state = "SUBMITTED"

             update ppsgui_orders
                 set ppsgui_orders.job_state = inserted.job_state,
                     ppsgui_orders.state_date = getdate()
                 from ppsgui_orders, inserted
                 where ppsgui_orders.job_id = inserted.job_id

	end

	if update(insert_top_flag)
	begin
                update schedule
                  set schedule.insert_top_flag = inserted.insert_top_flag
                from schedule, inserted
                where schedule.job_id = inserted.job_id
 
		update ppsgui_orders
		  set ppsgui_orders.insert_top_flag = inserted.insert_top_flag
		from ppsgui_orders, inserted
		where ppsgui_orders.job_id = inserted.job_id
	end
end
go
