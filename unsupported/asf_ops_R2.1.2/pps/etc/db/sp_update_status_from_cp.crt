/*************************************************************************
 * Copyright(c) 1996, California Institute of Technology.                *
 *             ALL RIGHTS RESERVED.                                      *
 * U.S. Government Sponsorship acknowledged.                             *
 *************************************************************************/
/*=======================
        @(#)sp_update_status_from_cp.crt	1.3  04/23/97
=========================*/

if exists (select * from sysobjects where name = "sp_update_status_from_cp")
	drop proc sp_update_status_from_cp
go

create proc sp_update_status_from_cp(
		@job_id int, 
		@job_state JobStateType,
		@dataset   varchar(255),
		@product_id varchar(255),
		@comment    varchar(255))
as
	declare @current_job_state JobStateType

	select @current_job_state = job_state
		from jobs 
		where job_id = @job_id

	if (@current_job_state != "SUBMITTED" and
			@current_job_state != "RETRY") 
		return 0

	begin transaction

	
	update jobs
		set job_state = @job_state,
		    state_date = getdate(),
		    dataset = @dataset,
		    product_id = @product_id,
		    job_comment = @comment
		where job_id = @job_id

        if (@@transtate > 0)
        begin
                rollback transaction
                return -100 
        end

	/* update trigger will update schedule table */

	commit transaction

	return 1 
go
